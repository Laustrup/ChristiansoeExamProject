<!DOCTYPE html>
<html lang="en">


    <div id="tourChooser" class="tourChooser">
        <div class="tourList">
            <table>
                <thead>
                    <tr>
                        <th>Navn</th>
                        <th>Beskrivelse</th>
                    </tr>
                </thead>
                <tbody id="tourChooserTable">
                </tbody>
            </table>

            <div class="modalBtnFlex">
                <button id="selectTourBtn" class="modalBtn">Vælg tur</button>
                <button id="closeTourChooser" class="modalBtn">Luk</button>
            </div>
        </div>
    </div>

    <div id="loadingPrompt" class="tourChooser">
        <h1>Indlæser tur</h1>
    </div>

    <div class="flex-container">
        <div id="map" class="map"></div>

        <div class="flex-sidebar">
            <button id="tourBtn" class="tourBtn">Vælg en tur!</button>

            <p>This doesn't exist</p>
            <div class="locationChooserFlex">
                <button id="locationChooserBtn">Show Location</button>
                <input type="text" id="locationId">
            </div>
        </div>
    </div>

    <script>

        setUpMap()
        setUpHandlers()

        function setUpMap() {
            let map = L.map('map').setView([55.3203, 15.1877], 16)

            let tiles = L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoiZ2Vvd2FsbCIsImEiOiJja3dvc28yeHkwNjBjMm9sMHB1NGlkdTJsIn0.-zQAF2T_9EOKLHEGnbUV4w', {
                attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
                maxZoom: 18,
                id: 'mapbox/streets-v11',
                tileSize: 512,
                zoomOffset: -1,
            }).addTo(map)
        }

        function setUpHandlers() {
            document.getElementById("tourBtn").onclick = showTourChooser
            document.getElementById("tourChooserTable").onclick = selectTour
            document.getElementById("selectTourBtn").onclick = chooseTour
            document.getElementById("closeTourChooser").onclick = closeTourChooser
        }

        function showTourChooser(){
            fetch("http://localhost:8080/tours")
                .then((response) => {
                    return response.json()
                })
                .then((data) => {
                    const tourList = []

                    for(let i = 0; i < data.length; i++){
                        tourList.push({
                            title: data[i].title,
                            description: data[i].report,
                            id: data[i].id
                        })
                    }
                    setUpTourListHTML(tourList)
                })
            document.getElementById("tourChooser").style.display = "flex"
        }

        function selectTour(ev){
            let table = document.getElementById("tourChooserTable")
            let rowIndex = ev.target.parentElement.rowIndex - 1
            let maxRows = table.rows.length


            for(let i = 0; i < maxRows; i++){
                let row = document.getElementById("tour_" + i)
                if(i === rowIndex){
                    row.style.backgroundColor = "dodgerblue"
                    row.setAttribute("data-selected", "yes")
                }
                else{
                    row.style.backgroundColor = "transparent"
                    row.setAttribute("data-selected", "no")
                }
            }
        }

        function chooseTour(){
            let table = document.getElementById("tourChooserTable")
            let maxRows = table.rows.length

            for(let i = 0; i < maxRows; i++){
                let row = document.getElementById("tour_" + i)
                if(row.getAttribute("data-selected") === "yes") {
                    let id = row.getAttribute("data-id")
                    getTour(id)
                    return
                }
            }
            alert("You need to select a tour")
        }

        function closeTourChooser(){
            document.getElementById("tourChooser").style.display = "none"
        }

        function getTour(id){
            document.getElementById("tourChooser").style.display = "none"
            document.getElementById("loadingPrompt").style.display = "flex"

            fetch("http://localhost:8080/tour?id=" + id)
                .then((response) => {
                    return response.json()
                })
                .then((data) => {
                    console.log(data)
                    document.getElementById("loadingPrompt").style.display = "none"
                })
        }

        function setUpTourListHTML(tours){
            let finalHTML = generateTourListHTML(tours)

            let tableBody = document.getElementById("tourChooserTable")
            tableBody.innerHTML = finalHTML
        }

        function generateTourListHTML(tours){
            let finalHTML = ""
            for(let i = 0; i < tours.length; i++){
                let rowId = "tour_" + i
                finalHTML +=
                    `<tr id=${rowId}  data-selected="no" data-id=${tours[i].id}>
                        <td>${tours[i].title}</td>
                        <td>${tours[i].description}</td>
                    </tr>
                    `
            }
            return finalHTML
        }

        //TODO: Delete this shit

        setUpLocationChooser()
        function setUpLocationChooser(){
            let btn = document.getElementById("locationChooserBtn")

            btn.onclick = () => {
                let input = document.getElementById("locationId").value
                sessionStorage.setItem("locationId", input)
                window.location.href = "http://localhost:8080/post"
            }
        }

    </script>

</html>